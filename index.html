<!DOCTYPE html>
<html>
<head>
    <title>çµæ®ºåœ˜ V3.9-Backtest (æ™‚é–“ç´€éŒ„ç‰ˆ)</title>
    <style>
        body { background: #050505; color: #d4d4d4; font-family: 'Consolas', monospace; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #1a1a1a; padding: 15px; border-radius: 4px; border-top: 4px solid #00bcd4; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #222; color: #00bcd4; padding: 12px; border: 1px solid #333; text-align: left; font-size: 13px; }
        td { padding: 10px; border: 1px solid #1a1a1a; font-size: 14px; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255,235,59,0.05); }
        .ENTRY { color: #fff; background: #d32f2f; font-weight: bold; box-shadow: inset 0 0 10px #000; }
        .time-label { color: #888; font-size: 12px; }
        .oi-grow { color: #00ff00; font-weight: bold; }
        .oi-fail { color: #ff4444; font-size: 12px; }
        .del-btn { background: #333; color: #888; border: none; cursor: pointer; padding: 5px 10px; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div>
            <span style="font-size: 20px; font-weight: bold;">V3.9-Backtest (åµæ¸¬æ™‚é–“ç´€éŒ„ç‰ˆ)</span><br>
            <span style="font-size: 12px; color: #888;">å·¦å´ç´€éŒ„ READY / ENTRY è§¸ç™¼æ™‚é–“ | æ’é™¤ BTC, ETH, SOL, XRP, BNB, BNX</span>
        </div>
        <button style="background: #00838f; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px;" onclick="toggleSystem()" id="startBtn">â–¶ å•Ÿå‹•å›æ¸¬</button>
        <div id="status" style="margin-left: auto; color: #00bcd4;">ç­‰å¾…å•Ÿå‹•...</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>åµæ¸¬æ™‚é–“</th>
                <th>æ¨™çš„</th>
                <th>åƒ¹æ ¼ / 3Dé«˜</th>
                <th>è³‡è²»</th>
                <th>5mé‡èƒ½</th>
                <th>OI è®Šå‹• (å°æ¯”åº•ç¢¼)</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="mainBody"></tbody>
    </table>

<script>
    const CONFIG = {
        FIXED_BLACKLIST: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'],
        FUND_LIMIT: -0.0002 // -0.02%
    };

    let isRunning = false, allData = {}, sessionBlacklist = new Set();
    let preHeatOI = {}, startTime = {}; // startTime ç”¨ä¾†å­˜é€²å…¥ READY æˆ– ENTRY çš„æ™‚é–“

    function getTime() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ":" + 
               now.getMinutes().toString().padStart(2, '0') + ":" + 
               now.getSeconds().toString().padStart(2, '0');
    }

    async function fetchUpdate() {
        if (!isRunning) return;
        try {
            const [pRes, fRes, tRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/price'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
            ]);
            const prices = await pRes.json(), funds = await fRes.json(), tickers = await tRes.json();
            
            const eligible = funds.filter(f => 
                f.symbol.endsWith('USDT') && 
                !CONFIG.FIXED_BLACKLIST.includes(f.symbol) && 
                !sessionBlacklist.has(f.symbol) &&
                parseFloat(f.lastFundingRate) <= CONFIG.FUND_LIMIT
            );

            for (let fI of eligible) {
                const symbol = fI.symbol;
                if (!allData[symbol]) {
                    const hRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=3`);
                    const hData = await hRes.json();
                    allData[symbol] = { high: Math.max(...hData.map(k => parseFloat(k[2]))) };
                }

                const pI = prices.find(p => p.symbol === symbol), tI = tickers.find(t => t.symbol === symbol);
                const price = parseFloat(pI.price), high = allData[symbol].high;
                const fund = (parseFloat(fI.lastFundingRate)*100).toFixed(4);
                const dist = ((high - price) / high * 100).toFixed(2);
                
                const oRes = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
                const oData = await oRes.json();
                const currentOI = parseFloat(oData.openInterest);

                const isToxicVol = parseFloat(tI.count) > 4000; 
                let st = "SCAN";
                let oiDisplay = "--";

                // --- V3.9 æ ¸å¿ƒæ™‚é–“èˆ‡ç‹€æ…‹é‚è¼¯ ---
                if (dist <= 1.5 && price < high) {
                    st = "READY";
                    if (!preHeatOI[symbol]) {
                        preHeatOI[symbol] = currentOI;
                        startTime[symbol] = getTime(); // ç¬¬ä¸€æ¬¡é€²å…¥ READYï¼Œç´€éŒ„æ™‚é–“
                    }
                    oiDisplay = `<span style="color:#666">åº•ç¢¼é–å®š</span>`;
                } 
                else if (price >= high) {
                    const baseOI = preHeatOI[symbol] || currentOI;
                    const oiDiff = ((currentOI - baseOI) / baseOI * 100).toFixed(2);
                    
                    if (isToxicVol && currentOI > baseOI) {
                        // çœŸæ­£å…·å‚™æ¯’æ€§çš„çªç ´
                        if (allData[symbol].lastSt !== "ENTRY") {
                            st = "ENTRY";
                            startTime[symbol] = getTime(); // è½‰æˆ ENTRY çš„ç¬é–“ï¼Œæ›´æ–°æ™‚é–“
                        } else {
                            st = "ENTRY"; // ä¿æŒ ENTRY
                        }
                        oiDisplay = `<span class="oi-grow">â–² ${oiDiff}%</span>`;
                    } else {
                        st = "READY"; // å½æ¯’æ€§ï¼Œç¶­æŒ READY
                        oiDisplay = `<span class="oi-fail">å½æ¯’æ€§(${oiDiff}%)</span>`;
                    }
                } else {
                    delete preHeatOI[symbol];
                    delete startTime[symbol];
                }

                allData[symbol].lastSt = st;
                allData[symbol].row = { 
                    time: startTime[symbol] || "--",
                    symbol, price, high, fund, st, oiDisplay, isToxicVol 
                };
            }
            render();
            document.getElementById('status').innerText = `ç›£æ§ä¸­... ${getTime()}`;
        } catch (e) {}
    }

    function render() {
        const rows = Object.values(allData).filter(d => d.row).map(d => d.row).sort((a, b) => a.st === "ENTRY" ? -1 : 1);
        document.getElementById('mainBody').innerHTML = rows.map(c => `
            <tr class="${c.st}">
                <td class="time-label">${c.time}</td>
                <td><b>${c.symbol}</b></td>
                <td>${c.price} / <span style="color:#666">${c.high}</span></td>
                <td style="color:#ff5252">${c.fund}%</td>
                <td style="color:${c.isToxicVol ? '#ff5722' : '#666'}">${c.isToxicVol ? 'ğŸ”¥çˆ†é‡' : 'æ­£å¸¸'}</td>
                <td>${c.oiDisplay}</td>
                <td class="${c.st}">${c.st}</td>
                <td><button class="del-btn" onclick="sessionBlacklist.add('${c.symbol}'); render();">âœ•</button></td>
            </tr>
        `).join('');
    }

    function toggleSystem() {
        isRunning = !isRunning;
        document.getElementById('startBtn').innerText = isRunning ? "ğŸ›‘ åœæ­¢" : "â–¶ é–‹å§‹";
        if (isRunning) { fetchUpdate(); setInterval(fetchUpdate, 10000); }
    }
</script>
</body>
</html>
