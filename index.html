<!DOCTYPE html>
<html>
<head>
    <title>çµæ®ºåœ˜ V3.8-Backtest (è³‡è²»æ”¾å¯¬ç‰ˆ)</title>
    <style>
        body { background: #050505; color: #d4d4d4; font-family: 'Consolas', monospace; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #1a1a1a; padding: 15px; border-radius: 4px; border-top: 4px solid #f44336; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #222; color: #ff5252; padding: 12px; border: 1px solid #333; text-align: left; }
        td { padding: 10px; border: 1px solid #1a1a1a; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255,235,59,0.05); }
        .ENTRY { color: #fff; background: #d32f2f; font-weight: bold; }
        .HOLD { color: #00e676; font-weight: bold; background: rgba(0, 230, 118, 0.1); }
        .oi-grow { color: #00ff00; font-weight: bold; }
        .oi-fall { color: #ff4444; }
        .del-btn { background: #333; color: #888; border: none; cursor: pointer; padding: 5px 10px; }
        .del-btn:hover { background: #ff4444; color: #fff; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div>
            <span style="font-size: 20px; font-weight: bold;">V3.8-Backtest (è³‡è²» -0.02% å•Ÿå‹•)</span><br>
            <span style="font-size: 12px; color: #888;">é–€æª»ï¼šè³‡è²»è²  + çˆ†é‡ + OI é«˜æ–¼é ç†±åº•ç¢¼ | å°ˆä¾›å›æ¸¬</span>
        </div>
        <button style="background: #c62828; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px;" onclick="toggleSystem()" id="startBtn">â–¶ é–‹å§‹ç¡¬æ ¸ç›£æ§</button>
        <div id="status" style="margin-left: auto; color: #ffeb3b;">ç­‰å¾…æŒ‡ä»¤...</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>æ¨™çš„</th>
                <th>åƒ¹æ ¼ / 3Dé«˜</th>
                <th>è³‡è²»</th>
                <th>5mé‡èƒ½</th>
                <th>OI è®Šå‹• (vs é ç†±)</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="mainBody"></tbody>
    </table>

<script>
    const CONFIG = {
        FIXED_BLACKLIST: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'],
        VOL_X: 2.5,
        FUND_LIMIT: -0.0002 // -0.02%
    };

    let isRunning = false, allData = {}, sessionBlacklist = new Set();
    let preHeatOI = {}; // å­˜å„² READY éšæ®µçš„ OI åŸºæº–

    async function fetchUpdate() {
        if (!isRunning) return;
        try {
            const [pRes, fRes, tRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/price'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
            ]);
            const prices = await pRes.json(), funds = await fRes.json(), tickers = await tRes.json();
            
            // ç¯©é¸ï¼šè³‡è²» <= -0.02% çš„å¹£
            const eligible = funds.filter(f => 
                f.symbol.endsWith('USDT') && 
                !CONFIG.FIXED_BLACKLIST.includes(f.symbol) && 
                !sessionBlacklist.has(f.symbol) &&
                parseFloat(f.lastFundingRate) <= CONFIG.FUND_LIMIT
            );

            for (let fI of eligible) {
                const symbol = fI.symbol;
                if (!allData[symbol]) {
                    const hRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=3`);
                    const hData = await hRes.json();
                    allData[symbol] = { high: Math.max(...hData.map(k => parseFloat(k[2]))) };
                }

                const pI = prices.find(p => p.symbol === symbol), tI = tickers.find(t => t.symbol === symbol);
                const price = parseFloat(pI.price), high = allData[symbol].high;
                const fund = (parseFloat(fI.lastFundingRate)*100).toFixed(4);
                const dist = ((high - price) / high * 100).toFixed(2);
                
                // ç²å– OI
                const oRes = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
                const oData = await oRes.json();
                const currentOI = parseFloat(oData.openInterest);

                // é‡èƒ½æ¯’æ€§æª¢æŸ¥ (24hæˆäº¤ç­†æ•¸ä¼°ç®—)
                const isToxicVol = parseFloat(tI.count) > 4500; 

                let st = "SCAN";
                let oiDisplay = "--";

                // --- V3.8 æ ¸å¿ƒåˆ¤æ–·é‚è¼¯ ---
                if (dist <= 1.5 && price < high) {
                    st = "READY";
                    if (!preHeatOI[symbol]) preHeatOI[symbol] = currentOI; // é€²å…¥å€åŸŸï¼Œé–å®šåº•ç¢¼
                    oiDisplay = `<span style="color:#666">åº•ç¢¼: ${currentOI.toFixed(0)}</span>`;
                } 
                else if (price >= high) {
                    const baseOI = preHeatOI[symbol] || currentOI; 
                    const oiDiff = ((currentOI - baseOI) / baseOI * 100).toFixed(2);
                    
                    // åªæœ‰çˆ†é‡ + OI çœŸçš„æœ‰å¢åŠ æ‰äº® ENTRY
                    if (isToxicVol && currentOI > baseOI) {
                        st = "ENTRY";
                        oiDisplay = `<span class="oi-grow">â–² ${oiDiff}% (ç¢ºæ ¸)</span>`;
                    } else {
                        st = "READY"; // ç ´äº†ä½†ä¸ç¬¦åˆæ¯’æ€§æ¢ä»¶ï¼Œä¸€å¾‹æ‰£åœ¨ READY
                        oiDisplay = `<span class="oi-fall">å½æ¯’æ€§ (${oiDiff}%)</span>`;
                    }
                } else {
                    delete preHeatOI[symbol]; // é›¢é–‹å€åŸŸï¼Œæ¸…é™¤åº•ç¢¼
                }

                allData[symbol].row = { symbol, price, high, fund, dist, st, oiDisplay, isToxicVol };
            }
            render();
            document.getElementById('status').innerText = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleTimeString()}`;
        } catch (e) {}
    }

    function render() {
        const rows = Object.values(allData).filter(d => d.row).map(d => d.row).sort((a, b) => a.dist - b.dist);
        document.getElementById('mainBody').innerHTML = rows.map(c => `
            <tr class="${c.st}">
                <td><b>${c.symbol}</b></td>
                <td>${c.price} / <span style="color:#666">${c.high}</span></td>
                <td style="color:#ff5252">${c.fund}%</td>
                <td style="color:${c.isToxicVol ? '#ff5722' : '#666'}">${c.isToxicVol ? 'ğŸ”¥çˆ†é‡' : 'æ­£å¸¸'}</td>
                <td>${c.oiDisplay}</td>
                <td class="${c.st}">${c.st}</td>
                <td><button class="del-btn" onclick="sessionBlacklist.add('${c.symbol}'); render();">âœ•</button></td>
            </tr>
        `).join('');
    }

    function toggleSystem() {
        isRunning = !isRunning;
        document.getElementById('startBtn').innerText = isRunning ? "ğŸ›‘ åœæ­¢" : "â–¶ é–‹å§‹";
        if (isRunning) { fetchUpdate(); setInterval(fetchUpdate, 12000); }
    }
</script>
</body>
</html>
