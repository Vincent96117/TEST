<!DOCTYPE html>
<html>
<head>
    <title>çµæ®ºåœ˜ V4.0-Backtest (æ—¥èªŒç‰ˆ)</title>
    <style>
        body { background: #050505; color: #d4d4d4; font-family: 'Consolas', monospace; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #1a1a1a; padding: 15px; border-radius: 4px; border-top: 4px solid #00bcd4; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th { background: #222; color: #00bcd4; padding: 12px; border: 1px solid #333; text-align: left; }
        td { padding: 10px; border: 1px solid #1a1a1a; font-size: 14px; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255,235,59,0.1); }
        .ENTRY { color: #fff; background: #d32f2f; font-weight: bold; }
        /* æ—¥èªŒå€æ¨£å¼ */
        .log-container { background: #111; border: 1px solid #333; padding: 15px; border-radius: 4px; height: 300px; overflow-y: scroll; }
        .log-title { color: #ffeb3b; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .log-entry { font-size: 13px; padding: 5px 0; border-bottom: 1px solid #222; display: flex; gap: 15px; }
        .log-time { color: #00ffff; }
        .log-symbol { color: #ffeb3b; font-weight: bold; width: 80px; }
        .log-data { color: #aaa; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div>
            <span style="font-size: 20px; font-weight: bold;">V4.0-Backtest (æ—¥èªŒçµ‚æ¥µç‰ˆ)</span><br>
            <span style="font-size: 12px; color: #888;">å¼•åŠ›æ’åº + OI é ç†±åº•ç¢¼ + è‡ªå‹•æ—¥èªŒå­˜æª”</span>
        </div>
        <button style="background: #00838f; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px;" onclick="toggleSystem()" id="startBtn">â–¶ å•Ÿå‹•ç›£æ§</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>åµæ¸¬æ™‚é–“</th>
                <th>æ¨™çš„</th>
                <th>åƒ¹æ ¼ / 3Dé«˜</th>
                <th>è·é›¢ % (å¼•åŠ›)</th>
                <th>è³‡è²»</th>
                <th>5mé‡èƒ½</th>
                <th>OI è®Šå‹• (vs åº•ç¢¼)</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="mainBody"></tbody>
    </table>

    <div class="log-title">
        <span>ğŸ® çµæ®ºæˆåŠŸç´€éŒ„ (è‡ªå‹•å­˜æª”)</span>
        <button onclick="document.getElementById('logContent').innerHTML=''" style="font-size: 10px; cursor: pointer;">æ¸…é™¤æ—¥èªŒ</button>
    </div>
    <div class="log-container" id="logContent">
        <div style="color: #444; text-align: center; padding-top: 100px;">ç­‰å¾…ç¬¬ä¸€ç­†æ¯’æ€§ ENTRY ç™¼å‹•...</div>
    </div>

<script>
    const CONFIG = {
        FIXED_BLACKLIST: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'],
        FUND_LIMIT: -0.0002 
    };

    let isRunning = false, allData = {}, sessionBlacklist = new Set();
    let preHeatOI = {}, startTime = {}, loggedEntry = new Set(); 

    function getTime() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ":" + 
               now.getMinutes().toString().padStart(2, '0') + ":" + 
               now.getSeconds().toString().padStart(2, '0');
    }

    // å¯«å…¥æ—¥èªŒå‡½å¼
    function addLog(symbol, price, fund, oiDiff) {
        if (loggedEntry.has(symbol + "_" + startTime[symbol])) return; // é˜²æ­¢é‡è¤‡ç´€éŒ„
        const logContent = document.getElementById('logContent');
        if (loggedEntry.size === 0) logContent.innerHTML = ''; // æ¸…é™¤åˆå§‹æ–‡å­—
        
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `
            <span class="log-time">[${getTime()}]</span>
            <span class="log-symbol">${symbol}</span>
            <span class="log-data">çˆ†ç™¼åƒ¹: ${price} | è³‡è²»: ${fund}% | OI å¢å¹…: <span style="color:#00ff00">${oiDiff}%</span></span>
        `;
        logContent.prepend(entry); // æœ€æ–°çš„è¨˜åœ¨æœ€ä¸Šé¢
        loggedEntry.add(symbol + "_" + startTime[symbol]);
    }

    async function fetchUpdate() {
        if (!isRunning) return;
        try {
            const [pRes, fRes, tRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/price'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
            ]);
            const prices = await pRes.json(), funds = await fRes.json(), tickers = await tRes.json();
            
            const eligible = funds.filter(f => 
                f.symbol.endsWith('USDT') && 
                !CONFIG.FIXED_BLACKLIST.includes(f.symbol) && 
                !sessionBlacklist.has(f.symbol) &&
                parseFloat(f.lastFundingRate) <= CONFIG.FUND_LIMIT
            );

            for (let fI of eligible) {
                const symbol = fI.symbol;
                if (!allData[symbol]) {
                    const hRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=3`);
                    const hData = await hRes.json();
                    allData[symbol] = { high: Math.max(...hData.map(k => parseFloat(k[2]))) };
                }

                const pI = prices.find(p => p.symbol === symbol), tI = tickers.find(t => t.symbol === symbol);
                const price = parseFloat(pI.price), high = allData[symbol].high;
                const fund = (parseFloat(fI.lastFundingRate)*100).toFixed(4);
                const dist = parseFloat(((high - price) / high * 100).toFixed(2));
                
                const oRes = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
                const oData = await oRes.json();
                const currentOI = parseFloat(oData.openInterest);

                const isToxicVol = parseFloat(tI.count) > 4000; 
                let st = "SCAN";
                let oiDisplay = "--";
                let oiDiffFinal = "0";

                if (dist <= 1.5 && price < high) {
                    st = "READY";
                    if (!preHeatOI[symbol]) {
                        preHeatOI[symbol] = currentOI;
                        startTime[symbol] = getTime(); 
                    }
                    oiDisplay = `<span style="color:#666">åº•ç¢¼é–å®š</span>`;
                } 
                else if (price >= high) {
                    const baseOI = preHeatOI[symbol] || currentOI;
                    oiDiffFinal = ((currentOI - baseOI) / baseOI * 100).toFixed(2);
                    
                    if (isToxicVol && currentOI > baseOI) {
                        if (allData[symbol].lastSt !== "ENTRY") {
                            st = "ENTRY";
                            startTime[symbol] = getTime(); 
                            // --- è§¸ç™¼æ—¥èªŒç´€éŒ„ ---
                            addLog(symbol, price, fund, oiDiffFinal);
                        } else { st = "ENTRY"; }
                        oiDisplay = `<span class="oi-grow">â–² ${oiDiffFinal}%</span>`;
                    } else {
                        st = "READY"; 
                        oiDisplay = `<span style="color:#ff4444">å½æ¯’æ€§(${oiDiffFinal}%)</span>`;
                        if (!startTime[symbol]) startTime[symbol] = getTime();
                    }
                } else {
                    delete preHeatOI[symbol];
                    delete startTime[symbol];
                }

                allData[symbol].lastSt = st;
                allData[symbol].row = { 
                    time: startTime[symbol] || "--",
                    symbol, price, high, fund, dist, st, oiDisplay, isToxicVol 
                };
            }
            render();
        } catch (e) {}
    }

    function render() {
        const rows = Object.values(allData).filter(d => d.row).map(d => d.row);
        rows.sort((a, b) => {
            if (a.st === "ENTRY" && b.st !== "ENTRY") return -1;
            if (a.st !== "ENTRY" && b.st === "ENTRY") return 1;
            return a.dist - b.dist;
        });

        document.getElementById('mainBody').innerHTML = rows.map(c => `
            <tr class="${c.st}">
                <td style="color:#00ffff">${c.time}</td>
                <td><b>${c.symbol}</b></td>
                <td>${c.price} / <span style="color:#666">${c.high}</span></td>
                <td style="color:${c.dist < 0.5 ? '#ffeb3b' : '#aaa'}">${c.dist}%</td>
                <td style="color:#ff5252">${c.fund}%</td>
                <td>${c.isToxicVol ? 'ğŸ”¥çˆ†é‡' : 'æ­£å¸¸'}</td>
                <td>${c.oiDisplay}</td>
                <td class="${c.st}">${c.st}</td>
                <td><button class="del-btn" onclick="sessionBlacklist.add('${c.symbol}'); render();">âœ•</button></td>
            </tr>
        `).join('');
    }

    function toggleSystem() {
        isRunning = !isRunning;
        document.getElementById('startBtn').innerText = isRunning ? "ğŸ›‘ åœæ­¢" : "â–¶ é–‹å§‹";
        if (isRunning) { fetchUpdate(); setInterval(fetchUpdate, 10000); }
    }
</script>
</body>
</html>
